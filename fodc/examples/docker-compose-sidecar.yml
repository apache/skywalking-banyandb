# Licensed to Apache Software Foundation (ASF) under one or more contributor
# license agreements. See the NOTICE file distributed with
# this work for additional information regarding copyright
# ownership. Apache Software Foundation (ASF) licenses this file to you under
# the Apache License, Version 2.0 (the "License"); you may
# not use this file except in compliance with the License.
# You may obtain a copy of the License at
#
#     http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing,
# software distributed under the License is distributed on an
# "AS IS" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND,
# either express or implied.  See the License for the specific
# language governing permissions and limitations under the License.

# Docker Compose example showing FODC running as a sidecar alongside BanyanDB
# This demonstrates the sidecar pattern where FODC monitors and collects
# diagnostic data from the BanyanDB instance in the same pod/container group.

version: '3.8'

services:
  banyandb:
    image: ${BANYANDB_IMAGE:-apache/skywalking-banyandb:latest}
    container_name: banyandb
    command: standalone
    expose:
      - 17912  # gRPC port
      - 17913  # HTTP port
      - 2121   # Metrics port
    ports:
      - "17913:17913"  # HTTP API
      - "2121:2121"    # Metrics endpoint
    volumes:
      - banyandb-data:/data
      - /tmp:/tmp  # Shared volume for death rattle files
    healthcheck:
      test: ["CMD", "wget", "--quiet", "--tries=1", "--spider", "http://localhost:17913/api/healthz"]
      interval: 5s
      timeout: 3s
      retries: 5
    networks:
      - banyandb-network
    restart: unless-stopped

  # FODC Sidecar - runs alongside BanyanDB to monitor and collect diagnostic data
  fodc-sidecar:
    build:
      context: ../..
      dockerfile: fodc/Dockerfile
    container_name: fodc-sidecar
    command:
      - "--sidecar"
      - "--poll-interval=5s"
      - "--flight-recorder-path=/data/fodc-flight-recorder.bin"
      - "--flight-recorder-buffer=1000"
      - "--health-port=17914"
    environment:
      # Auto-discovery: FODC will discover BanyanDB on localhost (same network namespace)
      - BANYANDB_HOST=localhost
      - BANYANDB_METRICS_PORT=2121
      - BANYANDB_HTTP_PORT=17913
    expose:
      - 17914  # FODC health endpoint
    ports:
      - "17914:17914"  # FODC health endpoint (optional, for external access)
    volumes:
      - banyandb-data:/data  # Shared volume for flight recorder data
      - /tmp:/tmp  # Shared volume for death rattle files
    depends_on:
      banyandb:
        condition: service_healthy
    networks:
      - banyandb-network
    healthcheck:
      test: ["CMD", "wget", "--quiet", "--tries=1", "--spider", "http://localhost:17914/healthz"]
      interval: 10s
      timeout: 3s
      retries: 3
    restart: unless-stopped

volumes:
  banyandb-data:
    driver: local

networks:
  banyandb-network:
    driver: bridge

