# Licensed to the Apache Software Foundation (ASF) under one or more
# contributor license agreements.  See the NOTICE file distributed with
# this work for additional information regarding copyright ownership.
# The ASF licenses this file to You under the Apache License, Version 2.0
# (the "License"); you may not use this file except in compliance with
# the License.  You may obtain a copy of the License at
#
#     http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS,
# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
# See the License for the specific language governing permissions and
# limitations under the License.

# E2E test for FODC functionality
# This test verifies that FODC can:
# - Discover BanyanDB endpoints automatically
# - Start health endpoints (/healthz, /ready, /live)
# - Poll metrics from BanyanDB
# - Report correct health status

setup:
  env: compose
  file: docker-compose.yml
  timeout: 20m
  init-system-environment: ../../script/env
  steps:
    - name: set PATH
      command: export PATH=/tmp/skywalking-infra-e2e/bin:$PATH
    - name: install yq
      command: bash test/e2e-v2/script/prepare/setup-e2e-shell/install.sh yq
    - name: wait for BanyanDB to be ready
      command: |
        timeout=120
        elapsed=0
        while [ $elapsed -lt $timeout ]; do
          if curl -sf http://${banyandb_host}:17913/api/healthz > /dev/null 2>&1; then
            echo "BanyanDB is ready"
            break
          fi
          sleep 2
          elapsed=$((elapsed + 2))
        done
        if [ $elapsed -ge $timeout ]; then
          echo "BanyanDB failed to become ready"
          exit 1
        fi
    - name: wait for FODC to be ready
      command: |
        timeout=60
        elapsed=0
        while [ $elapsed -lt $timeout ]; do
          if curl -sf http://${banyandb_host}:17914/healthz > /dev/null 2>&1; then
            echo "FODC is ready"
            break
          fi
          sleep 2
          elapsed=$((elapsed + 2))
        done
        if [ $elapsed -ge $timeout ]; then
          echo "FODC failed to become ready"
          exit 1
        fi
    - name: wait for metrics collection
      command: |
        # Wait a bit for FODC to collect some metrics
        sleep 15

verify:
  # verify with retry strategy
  retry:
    # max retry count
    count: 20
    # the interval between two retries, in millisecond.
    interval: 10s
  cases:
    - includes:
      - fodc-cases.yaml

